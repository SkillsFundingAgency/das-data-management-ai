{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceEnvironmentName": {
            "type": "string"
        },
        "serviceName": {
            "type": "string"
        },
        "confidential_data": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "false",
                "true"
            ],
            "metadata": {
                "description": "Specifies that the Azure Machine Learning workspace holds highly confidential data."
            }
        },
        "tags": {
            "type": "object"
        },
        "resourceGroupLocation": {
            "type": "string"
        },
        "sharedEnvResourceGroup": {
            "type": "string"
        }//,
        // "sharedEnvVirtualNetworkName": {
        //     "type": "string"
        // },
        // "subnetObject": {
        //     "type": "object"
        // },
        // "subnetServiceEndpointList": {
        //     "type": "array"
        // },
        // "subnetDelegations": {
        //     "type": "array"
        // }
    },
    "variables": {
        "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/ml/templates/",
        "resourceNamePrefix": "[toLower(concat('das-', parameters('resourceEnvironmentName'),'-', parameters('serviceName')))]",
        "resourceGroupName": "[concat(variables('resourceNamePrefix'), '-rg')]",
        "appInsightsName": "[concat(variables('resourceNamePrefix'), '-ai')]",
        "workspaceName": "[concat(variables('resourceNamePrefix'), '-ml')]",
        "keyVaultName": "[concat(variables('resourceNamePrefix'), '-kv')]",
        "computeName": "cpucluster",
        "containerRegistryName": "[replace(concat(variables('resourceNamePrefix'), 'acr'), '-', '')]",
        "storageAccountName": "[replace(concat(variables('resourceNamePrefix'), 'str'), '-', '')]"
    },
    "resources": [
        {
            "apiVersion": "2020-10-01",
            "name": "[variables('resourceGroupName')]",
            "type": "Microsoft.Resources/resourceGroups",
            "location": "[parameters('resourceGroupLocation')]",
            "tags": "[parameters('tags')]",
            "properties": {}
        },
        // {
        //     "apiVersion": "2020-10-01",
        //     "name": "ml-subnet",
        //     "type": "Microsoft.Resources/deployments",
        //     "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
        //     "properties": {
        //         "mode": "Incremental",
        //         "templateLink": {
        //             "uri": "[concat(variables('deploymentUrlBase'),'subnet.json')]",
        //             "contentVersion": "1.0.0.0"
        //         },
        //         "parameters": {
        //             "virtualNetworkName": {
        //                 "value": "[parameters('sharedEnvVirtualNetworkName')]"
        //             },
        //             "subnetName": {
        //                 "value": "[parameters('subnetObject').name]"
        //             },
        //             "subnetAddressPrefix": {
        //                 "value": "[parameters('subnetObject').addressSpace]"
        //             },
        //             "serviceEndpointList": {
        //                 "value": "[parameters('subnetServiceEndpointList')]"
        //             },
        //             "delegations": {
        //                 "value": "[parameters('subnetDelegations')]"
        //             }
        //         }
        //     },
        //     "dependsOn": [
        //         "[variables('resourceGroupName')]"
        //     ]
        // },
        // {
        //     "apiVersion": "2020-10-01",
        //     "name": "container-registry",
        //     "type": "Microsoft.Resources/deployments",
        //     "resourceGroup": "[variables('resourceGroupName')]",
        //     "properties": {
        //         "mode": "Incremental",
        //         "templateLink": {
        //             "uri": "[concat(variables('deploymentUrlBase'),'container-registry.json')]",
        //             "contentVersion": "1.0.0.0"
        //         },
        //         "parameters": {
        //             "registryName": {
        //                 "value": "[variables('containerRegistryName')]"
        //             },
        //             "registrySkuName": {
        //                 "value": "Basic"
        //             },
        //             "subnetResourceIdList": {
        //                 "value": []
        //             }
        //         }
        //     },
        //     "dependsOn": [
        //         "[variables('resourceGroupName')]"
        //     ]
        // },
        {
            "apiVersion": "2020-10-01",
            "name": "ml-storage",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[variables('resourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'storage-account-arm.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "storageKind": {
                        "value": "StorageV2"
                    },
                    "subnetResourceIdList": {
                        "value": []
                    }
                }
            },
            "dependsOn": [
                "[variables('resourceGroupName')]"
            ]
        },
        {
            "apiVersion": "2020-10-01",
            "name": "ml-keyvault",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[variables('resourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'keyvault.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('keyVaultName')]"
                    },
                    "enableSoftDelete": {
                        "value": true
                    }
                }
            },
            "dependsOn": [
                "[variables('resourceGroupName')]"
            ]
        },
        {
            "apiVersion": "2020-10-01",
            "name": "ml-app-insights",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[variables('resourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appInsightsName": {
                        "value": "[variables('appInsightsName')]"
                    }
                }
            },
            "dependsOn": [
                "[variables('resourceGroupName')]"
            ]
        },
        {
            "apiVersion": "2020-10-01",
            "name": "ml-workspace",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[variables('resourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'machine-learning-workspace.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[variables('workspaceName')]"
                    },
                    "storageAccountResourceId": {
                        "value": "[reference('ml-storage').outputs.storageResourceId.value]"
                    },
                    "keyVaultResourceId": {
                        "value": "[reference('ml-keyvault').outputs.KeyVaultResourceId.value]"
                    },
                    "appInsightsResourceId": {
                        "value": "[reference('ml-app-insights').outputs.AppInsightsResourceId.value]"
                    },
                    "confidentialData": {
                        "value": "[parameters('confidential_data')]"
                    }
                }
            },
            "dependsOn": [
                "[variables('resourceGroupName')]"
            ]
        },
        {
            "apiVersion": "2020-10-01",
            "name": "ml-compute",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[variables('resourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'machine-learning-compute.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[variables('workspaceName')]"
                    },
                    "computeName":{
                        "value": "[variables('computeName')]"
                    },
                    "computeType": {
                        "value": "AmlCompute"
                    }
                }
            },
            "dependsOn": [
                "[variables('resourceGroupName')]",
                "ml-workspace"
            ]
        }
    ],
    "outputs": {
        "WorkspaceName": {
            "type": "string",
            "value": "[variables('workspaceName')]"
        },
        "ResourceGroupName": {
            "type": "string",
            "value": "[variables('resourceGroupName')]"
        },
        "ComputeName": {
            "type": "string",
            "value": "[variables('computeName')]"
        }
    }
}